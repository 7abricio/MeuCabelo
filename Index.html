<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Meu Cabelo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Plus+Jakarta+Sans:wght@200..800&display=swap');
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none; 
        }
        
        .font-serif { font-family: 'Playfair Display', serif; }
        
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* SCROLL SUPER FLU√çDO NATIVO PARA MOBILE */
        .smooth-scroll {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .toast-enter {
            animation: toastPopup 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes toastPopup {
            0% { transform: translate(-50%, 10px) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, 0) scale(1); opacity: 1; }
        }

        .perspective-container { perspective: 1200px; }
        
        .flip-card-enter {
            animation: flipCardIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }
        
        .flip-card-exit {
            animation: flipCardOut 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }

        @keyframes flipCardIn {
            0% { transform: rotateY(-90deg) scale(0.9); opacity: 0; }
            100% { transform: rotateY(0deg) scale(1); opacity: 1; }
        }
        
        @keyframes flipCardOut {
            0% { transform: rotateY(0deg) scale(1); opacity: 1; }
            100% { transform: rotateY(90deg) scale(0.9); opacity: 0; }
        }

        @media screen and (max-width: 768px) {
            input, select, textarea { font-size: 16px !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Detetor global de erros JS para evitar ecr√£ branco silencioso -->
    <script>
        window.addEventListener('error', function(e) {
            const errDiv = document.createElement('div');
            errDiv.style.cssText = 'position:fixed;top:20px;left:20px;right:20px;background:#ef4444;color:white;padding:15px;border-radius:12px;z-index:99999;font-family:sans-serif;box-shadow:0 10px 25px rgba(0,0,0,0.2);';
            errDiv.innerHTML = '<b style="font-size:16px;">üö® Erro na Aplica√ß√£o:</b><br><br>' + e.message + '<br><br><small>Abra a consola (F12) para ver detalhes. Se est√° a abrir o ficheiro HTML diretamente no PC, use um Live Server (CORS).</small>';
            document.body.appendChild(errDiv);
        });
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configura√ß√£o Firebase do Usu√°rio perfeitamente limpa (sem espa√ßos invis√≠veis)
        const firebaseConfig = {
            apiKey: "AIzaSyBf1QNBMm8vtqVZoiwDxDYtLqAEDIRAudQ",
            authDomain: "meu-cabelo-app.firebaseapp.com",
            projectId: "meu-cabelo-app",
            storageBucket: "meu-cabelo-app.firebasestorage.app",
            messagingSenderId: "348474330654",
            appId: "1:348474330654:web:af75d39dc2ea95b479280f"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'meu-cabelo-app';

        const { useState, useEffect, useMemo, useRef } = React;

        const getThemeColors = (isDark) => ({
            bg: isDark ? 'bg-[#1C1A19]' : 'bg-[#F9F6F0]',
            card: isDark ? 'bg-[#282624]' : 'bg-white',
            surface: isDark ? 'bg-[#32302D]' : 'bg-stone-50',
            surfaceHover: isDark ? 'hover:bg-[#3D3A36]' : 'hover:bg-stone-100',
            surfaceAlt: isDark ? 'bg-[#3D3A36]' : 'bg-stone-100',
            text: isDark ? 'text-[#D6D0C4]' : 'text-[#5C544E]',
            textStrong: isDark ? 'text-[#F0EBE1]' : 'text-stone-700',
            textMuted: isDark ? 'text-[#A39D93]' : 'text-stone-500',
            textLight: isDark ? 'text-[#8A847A]' : 'text-[#9A8F85]',
            iconMuted: isDark ? 'text-[#5A5550]' : 'text-stone-300',
            primary: isDark ? 'bg-[#384A41]' : 'bg-[#D2E0D9]',
            primaryText: isDark ? 'text-[#A5C2B3]' : 'text-[#4A6B5D]',
            accent: isDark ? 'bg-[#5C3C3A]' : 'bg-[#F3D8D6]',
            accentText: isDark ? 'text-[#DEAAA7]' : 'text-[#9C5A56]',
            yellow: isDark ? 'bg-[#4A3D1A]' : 'bg-[#FDF3D8]',
            yellowText: isDark ? 'text-[#E0BE63]' : 'text-[#B08922]',
            blue: isDark ? 'bg-[#2C3E4F]' : 'bg-[#D6E4F0]',
            blueText: isDark ? 'text-[#9CB8D4]' : 'text-[#4A6984]',
            purple: isDark ? 'bg-[#3D2C4A]' : 'bg-[#E5D9F2]',
            purpleText: isDark ? 'text-[#BCA3D4]' : 'text-[#7A5C8A]',
            orange: isDark ? 'bg-[#5A3A22]' : 'bg-[#FFE5D4]',
            orangeText: isDark ? 'text-[#ECA16A]' : 'text-[#C76A28]',
            greenCard: isDark ? 'bg-[#2A402A]' : 'bg-[#E0F0E0]',
            greenText: isDark ? 'text-[#7BB07B]' : 'text-[#3B7A3B]',
            teal: isDark ? 'bg-[#214040]' : 'bg-[#E0F0F0]',
            tealText: isDark ? 'text-[#5EB0B0]' : 'text-[#3B7A7A]',
            emerald: isDark ? 'bg-[#20402E]' : 'bg-[#E0F0E6]',
            emeraldText: isDark ? 'text-[#63B88A]' : 'text-[#3B7A55]',
            border: isDark ? 'border-[#3D3A36]' : 'border-[#EAE3D9]',
            bottomNav: isDark ? 'bg-[#282624]/90 border-[#3D3A36]' : 'bg-white/90 border-[#EAE3D9]',
            input: isDark ? 'bg-[#1C1A19] text-[#D6D0C4]' : 'bg-white text-stone-700',
            translucent: isDark ? 'bg-black/20' : 'bg-white/60',
            translucentStrong: isDark ? 'bg-black/40' : 'bg-white/70',
            notification: isDark ? 'bg-[#282624]/95 border-[#3D3A36]' : 'bg-white/95 border-stone-200',
            indigoCard: isDark ? 'bg-indigo-900/20 border-indigo-900/50' : 'bg-indigo-50/30 border-indigo-100',
            indigoText: isDark ? 'text-indigo-300' : 'text-indigo-900',
            blueCard: isDark ? 'bg-blue-900/20 border-blue-900/50' : 'bg-blue-50/30 border-blue-100',
            blueTextAlt: isDark ? 'text-blue-300' : 'text-blue-900',
            purpleCard: isDark ? 'bg-purple-900/20 border-purple-900/50' : 'bg-[#E5D9F2] bg-opacity-30 border-purple-100',
        });

        const HAIR_STATUS = [
            { id: 'danificado', icon: 'ph-warning-circle', color: 'text-orange-500', label: 'Danificado' },
            { id: 'seco', icon: 'ph-wind', color: 'text-yellow-600', label: 'Seco / Frizz' },
            { id: 'oleoso', icon: 'ph-drop-half', color: 'text-stone-400', label: 'Oleoso' },
            { id: 'normal', icon: 'ph-smiley', color: 'text-yellow-400', label: 'Bom' },
            { id: 'hidratado', icon: 'ph-drop', color: 'text-blue-400', label: 'Hidratado' },
            { id: 'perfeito', icon: 'ph-sparkle', color: 'text-pink-400', label: 'Incr√≠vel' },
        ];

        const TREATMENT_TYPES = [
            { id: 'hidratacao', label: 'üíß Hidrata√ß√£o', val: 1 },
            { id: 'nutricao', label: 'ü•ë Nutri√ß√£o', val: 2 },
            { id: 'reconstrucao', label: 'üõ°Ô∏è Reconstru√ß√£o', val: 3 },
            { id: 'detox', label: 'üåø Detox', val: 4 },
        ];

        const STAT_PERIODS = [
            { val: 'ontem', label: 'Ontem' },
            { val: 7, label: '7 D' },
            { val: 15, label: '15 D' },
            { val: 30, label: '30 D' },
            { val: 60, label: '60 D' },
            { val: 90, label: '90 D' }
        ];

        const WEEKDAYS = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const MONTHS = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        const getTodayStr = () => {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        
        const formatDateVisual = (dateStr) => {
            const [y, m, d] = dateStr.split('-');
            const date = new Date(y, m - 1, d);
            return `${date.getDate()} de ${MONTHS[date.getMonth()]}, ${y}`;
        };

        const INITIAL_USERS_DB = {};

        const Button = ({ children, onClick, variant = 'primary', className = '', colors }) => {
            const variants = {
                primary: `${colors.primary} ${colors.primaryText} hover:brightness-110`,
                accent: `${colors.accent} ${colors.accentText} hover:brightness-110`,
                purple: `${colors.purple} ${colors.purpleText} hover:brightness-110`,
                blue: `${colors.blue} ${colors.blueText} hover:brightness-110`,
                orange: `${colors.orange} ${colors.orangeText} hover:brightness-110`,
                teal: `${colors.teal} ${colors.tealText} hover:brightness-110`,
                emerald: `${colors.emerald} ${colors.emeraldText} hover:brightness-110`,
                outline: `border-2 ${colors.border} ${colors.text} ${colors.surfaceHover}`,
            };
            return <button type="button" onClick={onClick} className={`px-4 py-2 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 ${variants[variant]} ${className}`}>{children}</button>;
        };

        const Card = ({ children, className = '', colors, onClick }) => (
            <div onClick={onClick} className={`${colors.card} rounded-3xl p-6 shadow-sm border ${colors.border} transition-transform duration-300 ${onClick ? 'cursor-pointer hover:scale-[1.02] hover:shadow-md' : ''} ${className}`}>{children}</div>
        );

        function App() {
            const [notifications, setNotifications] = useState([]);
            
            const addNotification = (msg, isError = false) => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, msg, isError }]);
                setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 6000);
            };

            const [user, setUser] = useState(null);
            
            // Autentica√ß√£o Firebase (An√≥nima) com Gest√£o de Erros
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof window !== 'undefined' && window.__initial_auth_token) {
                            await signInWithCustomToken(auth, window.__initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Erro na Autentica√ß√£o Firebase:", error);
                        addNotification("üö® Erro de Liga√ß√£o: V√° √† consola Firebase > Authentication > ative 'Anonymous'.", true);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            const [deferredPrompt, setDeferredPrompt] = useState(null);
            useEffect(() => {
                const handleBIP = (e) => { e.preventDefault(); setDeferredPrompt(e); };
                window.addEventListener('beforeinstallprompt', handleBIP);
                return () => window.removeEventListener('beforeinstallprompt', handleBIP);
            }, []);

            const [isDarkMode, setIsDarkMode] = useState(false);
            const colors = useMemo(() => getThemeColors(isDarkMode), [isDarkMode]);
            const toggleTheme = () => setIsDarkMode(!isDarkMode);

            const [usersDb, setUsersDb] = useState(INITIAL_USERS_DB);
            const [currentUsername, setCurrentUsername] = useState(null);

            const [authStep, setAuthStep] = useState('auth'); 
            const [isLoginFlow, setIsLoginFlow] = useState(true);
            const [userName, setUserName] = useState('');
            const [isEditingName, setIsEditingName] = useState(false);
            const [editNameInput, setEditNameInput] = useState('');

            const [usernameInput, setUsernameInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [securityAnswerInput, setSecurityAnswerInput] = useState('');

            const TABS_ORDER = ['home', 'calendar', 'stats'];
            const [activeTab, setActiveTab] = useState('home');
            
            const [realTodayStr, setRealTodayStr] = useState(getTodayStr());
            const [activeDateStr, setActiveDateStr] = useState(getTodayStr()); 
            
            const [isNavOpen, setIsNavOpen] = useState(false);
            const navTouchStartY = useRef(0);
            const isNavDragging = useRef(false);
            
            const [activeStatModal, setActiveStatModal] = useState(null);
            const [isClosingModal, setIsClosingModal] = useState(false);

            const [statusFeedback, setStatusFeedback] = useState(null);
            const statusTimeoutRef = useRef(null);

            const [logs, setLogs] = useState({});
            const [products, setProducts] = useState([]);

            const [extraInput, setExtraInput] = useState({ type: '', duration: '' });
            const [salonInput, setSalonInput] = useState({ procedures: '', notes: '', mood: 'perfeito' });
            const [isAddingProduct, setIsAddingProduct] = useState(false);
            const [newProductInput, setNewProductInput] = useState({ name: '', time: '08:00' });
            
            const [statsPeriod, setStatsPeriod] = useState(15);
            const [viewingMonth, setViewingMonth] = useState(new Date());
            const [selectedHistoryDate, setSelectedHistoryDate] = useState(getTodayStr());

            // Buscar todos os usu√°rios do Firestore
            useEffect(() => {
                if (!user) return;
                
                try {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    const unsubscribe = onSnapshot(usersRef, (snapshot) => {
                        const dbUsers = {};
                        snapshot.forEach(doc => {
                            dbUsers[doc.id] = doc.data();
                        });
                        setUsersDb(prev => ({ ...INITIAL_USERS_DB, ...dbUsers }));
                    }, (error) => {
                        console.error("Firestore read error:", error);
                        addNotification("üö® Erro Base de Dados: Verifique as regras de seguran√ßa no Firestore (devem estar no modo de teste).", true);
                    });
                    
                    return () => unsubscribe();
                } catch (e) {
                    console.error("Setup Firestore error:", e);
                }
            }, [user]);

            // Salvar no Firebase as altera√ß√µes ativas (Di√°rio / Produtos)
            useEffect(() => {
                if (currentUsername && authStep === 'app' && user) {
                    setUsersDb(prev => ({ ...prev, [currentUsername]: { ...prev[currentUsername], logs, products } }));
                    
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUsername);
                    setDoc(userRef, { logs, products }, { merge: true }).catch(err => {
                        console.error(err);
                        addNotification("üö® Erro ao guardar registo: Falta permiss√£o no Firestore.", true);
                    });
                }
            }, [logs, products, currentUsername, authStep, user]);

            const getSafeDayLog = (dateStr) => {
                const log = logs[dateStr] || {};
                return {
                    status: log.status || [],
                    treatment: log.treatment || { minutes: 0, type: '' },
                    routine: log.routine || {},
                    heat: log.heat || { active: false, protectant: false },
                    salon: log.salon || null,
                    extras: log.extras || []
                };
            };

            const dayLog = getSafeDayLog(activeDateStr);

            const updateActiveLog = (key, value) => {
                setLogs(prev => {
                    const safeLog = getSafeDayLog(activeDateStr);
                    return { ...prev, [activeDateStr]: { ...safeLog, [key]: value } };
                });
            };

            const handleStatusSelect = (s) => {
                updateActiveLog('status', [...dayLog.status, {time: formatTime(new Date()), status: s.id}]);
                setStatusFeedback(s.label);
                if (statusTimeoutRef.current) clearTimeout(statusTimeoutRef.current);
                statusTimeoutRef.current = setTimeout(() => { setStatusFeedback(null); }, 2000);
            };

            const handleAuthSubmit = () => {
                if (!usernameInput || !passwordInput) return addNotification("Preencha utilizador e palavra-passe!", true);
                const userKey = usernameInput.toLowerCase().trim();
                if (isLoginFlow) {
                    const userAccount = usersDb[userKey];
                    if (userAccount && userAccount.password === passwordInput) {
                        setCurrentUsername(userKey); setUserName(userAccount.name); setLogs(userAccount.logs || {}); 
                        setProducts(userAccount.products || []); setActiveDateStr(getTodayStr()); setIsNavOpen(false); 
                        setAuthStep('app'); setActiveTab('home');
                        addNotification("Login com sucesso! Bem-vinda de volta.");
                    } else addNotification("Utilizador ou palavra-passe incorretos!", true);
                } else {
                    if (usersDb[userKey]) return addNotification("Este utilizador j√° existe!", true);
                    setLogs({}); setProducts([]); setSecurityAnswerInput(''); setAuthStep('onboarding');
                }
            };

            const handleOnboardingSubmit = async () => {
                if (!userName.trim() || !securityAnswerInput.trim()) return addNotification("Por favor, preencha todos os campos!", true);
                if (!user) return addNotification("üö® A aguardar liga√ß√£o ao Firebase. Tente em 2 segundos...", true);
                
                const userKey = usernameInput.toLowerCase().trim();
                
                const newUser = { 
                    password: passwordInput, 
                    name: userName.trim(), 
                    securityAnswer: securityAnswerInput.toLowerCase().trim(), 
                    logs: {}, 
                    products: [] 
                };

                // Guardar local e Firebase
                setUsersDb(prev => ({ ...prev, [userKey]: newUser }));
                
                try {
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userKey);
                    await setDoc(userRef, newUser);
                    addNotification("Conta criada e guardada na nuvem com sucesso! ‚òÅÔ∏è");
                    
                    setCurrentUsername(userKey); setIsNavOpen(false); setAuthStep('app'); setActiveTab('home');
                } catch (e) {
                    console.error("Erro ao salvar no Firestore:", e);
                    addNotification(`üö® Erro ao guardar conta: As regras de permiss√£o do Firestore est√£o bloqueadas.`, true);
                }
            };

            const handleRecoverySubmit = () => {
                if (!usernameInput || !securityAnswerInput) return addNotification("Preencha o utilizador e o nome da av√≥!", true);
                const userKey = usernameInput.toLowerCase().trim();
                const userAccount = usersDb[userKey];
                if (userAccount && userAccount.securityAnswer === securityAnswerInput.toLowerCase().trim()) {
                    addNotification(`A sua palavra-passe √©: ${userAccount.password}`);
                    setTimeout(() => setAuthStep('auth'), 4000); 
                } else addNotification("Utilizador ou resposta secreta incorretos.", true);
            };

            const handleLogout = () => {
                setAuthStep('auth'); setIsLoginFlow(true); setCurrentUsername(null); setUserName('');
                setUsernameInput(''); setPasswordInput(''); setSecurityAnswerInput(''); setIsEditingName(false);
                setLogs({}); setProducts([]); setActiveDateStr(getTodayStr());
                setExtraInput({ type: '', duration: '' }); setSalonInput({ procedures: '', notes: '', mood: 'perfeito' });
                setNewProductInput({ name: '', time: '08:00' }); setIsAddingProduct(false);
            };

            const handleSaveName = async () => {
                if(editNameInput.trim()) {
                    const newName = editNameInput.trim();
                    setUserName(newName);
                    setUsersDb(prev => ({ ...prev, [currentUsername]: { ...prev[currentUsername], name: newName } }));
                    
                    if (user) {
                        try {
                            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUsername);
                            await setDoc(userRef, { name: newName }, { merge: true });
                        } catch(e) {
                            console.error(e);
                            addNotification("Erro ao atualizar o nome no servidor.", true);
                        }
                    }
                }
                setIsEditingName(false);
            };

            const handleNavTouchStart = (e) => {
                navTouchStartY.current = e.touches[0].clientY;
                isNavDragging.current = false;
            };

            const handleNavTouchMove = (e) => {
                const deltaY = e.touches[0].clientY - navTouchStartY.current;
                if (Math.abs(deltaY) > 10) {
                    isNavDragging.current = true;
                }
            };

            const handleNavTouchEnd = (e) => {
                if (!isNavDragging.current) return; 

                const deltaY = e.changedTouches[0].clientY - navTouchStartY.current;
                if (deltaY < -15) setIsNavOpen(true);
                else if (deltaY > 15) setIsNavOpen(false);
            };

            const handleNavClick = (e) => {
                e.stopPropagation();
                if (isNavDragging.current) {
                    isNavDragging.current = false;
                    return; 
                }
                setIsNavOpen(prev => !prev);
            };

            const activeIndex = TABS_ORDER.indexOf(activeTab);

            const handleAddProduct = () => {
                if (newProductInput.name) {
                    setProducts([...products, { id: Date.now().toString(), name: newProductInput.name, time: newProductInput.time }]);
                    setNewProductInput({ name: '', time: '08:00' }); setIsAddingProduct(false);
                } else addNotification("Preencha o nome do produto!", true);
            };

            const stats = useMemo(() => {
                const today = new Date();
                let totalTreatMins = 0, treatDays = 0, productUsed = 0, productTotal = 0;
                let heatDays = 0, protectedDays = 0, totalSalon = 0, totalExtrasMins = 0;
                
                let countCorte = 0, countCor = 0, countEscova = 0;

                const statusCounts = {}, salonMoodCounts = {};

                const startDay = statsPeriod === 'ontem' ? 1 : 0;
                const endDay = statsPeriod === 'ontem' ? 1 : statsPeriod - 1;

                for (let i = startDay; i <= endDay; i++) {
                    const d = new Date(today); d.setDate(d.getDate() - i);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const l = logs[dateStr];

                    if (l) {
                        if (l.treatment?.minutes) { totalTreatMins += l.treatment.minutes; treatDays++; }
                        products.forEach(p => { productTotal++; if (l.routine?.[p.id]) productUsed++; });
                        if (l.heat?.active) { heatDays++; if (l.heat.protectant) protectedDays++; }
                        l.extras?.forEach(ex => { totalExtrasMins += ex.duration; });

                        if (l.salon?.procedures) {
                            totalSalon++;
                            const pText = l.salon.procedures.toLowerCase();
                            if (pText.includes('cort') || pText.includes('apar')) countCorte++;
                            if (pText.includes('pint') || pText.includes('cor') || pText.includes('nuanc') || pText.includes('madeix') || pText.includes('descolor') || pText.includes('luzes')) countCor++;
                            if (pText.includes('escov') || pText.includes('secag') || pText.includes('penteado')) countEscova++;

                            if (l.salon.mood) salonMoodCounts[l.salon.mood] = (salonMoodCounts[l.salon.mood] || 0) + 1;
                        }
                        l.status?.forEach(m => { statusCounts[m.status] = (statusCounts[m.status] || 0) + 1; });
                    }
                }

                const avgTreat = treatDays ? Math.round(totalTreatMins / treatDays) : 0;
                const routineAdherence = productTotal ? Math.round((productUsed / productTotal) * 100) : 0;
                const topStatusId = Object.keys(statusCounts).sort((a,b) => statusCounts[b] - statusCounts[a])[0];
                const topStatus = HAIR_STATUS.find(m => m.id === topStatusId) || HAIR_STATUS.find(m => m.id === 'normal'); 
                const topSalonMoodId = Object.keys(salonMoodCounts).sort((a,b) => salonMoodCounts[b] - salonMoodCounts[a])[0];
                const topSalonMood = HAIR_STATUS.find(m => m.id === topSalonMoodId) || null;

                return { avgTreat, totalTreatMins, routineAdherence, heatDays, protectedDays, totalSalon, countCorte, countCor, countEscova, totalExtrasMins, topStatus, topSalonMood };
            }, [statsPeriod, logs, products]);

            const getInsightFor = (type) => {
                switch(type) {
                    case 'status': 
                        const goodStatuses = ['normal', 'hidratado', 'perfeito'];
                        if (goodStatuses.includes(stats.topStatus.id)) return "O seu cabelo tem estado com uma sa√∫de incr√≠vel! Continue com a rotina atual.";
                        if (stats.topStatus.id === 'oleoso') return "Tem notado os fios mais oleosos. Tente espa√ßar ligeiramente as lavagens ou usar um shampoo de limpeza profunda (detox) quinzenalmente.";
                        return "Parece que os fios andam a pedir socorro. Aumente a frequ√™ncia das m√°scaras de nutri√ß√£o e umecta√ß√£o com √≥leos.";
                    
                    case 'routine': return stats.routineAdherence > 80 ? "Disciplina de ferro! Tem usado os seus produtos quase todos os dias." : "Aten√ß√£o: tem esquecido de aplicar os seus produtos di√°rios. Const√¢ncia √© tudo para ver resultados!";
                    case 'treatment': return stats.totalTreatMins > 0 ? `Dedicou um total de ${stats.totalTreatMins} minutos aos tratamentos. √â este o segredo do brilho!` : "N√£o registou m√°scaras neste per√≠odo. O cabelo precisa de reposi√ß√£o de massa e √°gua semanalmente.";
                    case 'heat': 
                        if (stats.heatDays === 0) return "Excelente! N√£o usou calor neste per√≠odo. Secar ao natural √© a melhor coisa que pode fazer pela sa√∫de dos fios.";
                        if (stats.protectedDays === stats.heatDays) return `Perfeito! Usou secador ou chapinha em ${stats.heatDays} dias, mas protegeu SEMPRE o cabelo. O protetor t√©rmico √© o seu melhor amigo.`;
                        if (stats.protectedDays > 0) return `Aten√ß√£o! Usou fontes de calor em ${stats.heatDays} dias, mas esqueceu o protetor em alguns. O calor direto sem prote√ß√£o causa quebra imediata!`;
                        return `Alerta! Usou calor em ${stats.heatDays} dias e n√£o aplicou prote√ß√£o t√©rmica em NENHUM. Est√° a fritar as pontas, cuide disso!`;
                    
                    case 'salon': 
                        if (stats.totalSalon === 0) return `Ainda n√£o tirou um momento para se mimar no sal√£o neste per√≠odo. Que tal agendar um dia de puro autocuidado? O seu cabelo (e a sua mente) agradecem!`;
                        
                        let base = `Tirou ${stats.totalSalon} dia(s) para um merecido momento de autocuidado nas m√£os de um profissional! `;
                        
                        let servicesDone = [];
                        if (stats.countCorte > 0) servicesDone.push({ name: 'Corte', count: stats.countCorte, insight: 'Aparar as pontas √© o segredo para um cabelo leve, com movimento e crescimento forte.' });
                        if (stats.countCor > 0) servicesDone.push({ name: 'Cor/Madeixas', count: stats.countCor, insight: 'Renovar a cor faz maravilhas pela nossa energia! Cabelos iluminados s√≥ precisam de amor extra na reconstru√ß√£o.' });
                        if (stats.countEscova > 0) servicesDone.push({ name: 'Escova', count: stats.countEscova, insight: 'Sair do sal√£o com uma finaliza√ß√£o de luxo √© uma verdadeira inje√ß√£o de poder e confian√ßa.' });

                        if (servicesDone.length > 0) {
                            servicesDone.sort((a, b) => b.count - a.count); // Ordena pelos mais feitos
                            let topService = servicesDone[0];
                            
                            if (servicesDone.length === 1) {
                                return base + `O seu foco exclusivo foi ${topService.name} (${topService.count} vez/es). ${topService.insight}`;
                            } else if (servicesDone.length === 2 && servicesDone[0].count === servicesDone[1].count) {
                                return base + `A sua combina√ß√£o favorita foi ${servicesDone[0].name} e ${servicesDone[1].name} (${topService.count} vez/es cada). Uma dupla perfeita para se mimar e transformar o visual em simult√¢neo!`;
                            } else {
                                let extras = servicesDone.slice(1).map(s => s.name).join(' e ');
                                return base + `O servi√ßo que mais realizou foi ${topService.name} (${topService.count} vez/es). ${topService.insight} Tamb√©m aproveitou este per√≠odo para atualizar ${extras}. Excelente rotina de beleza!`;
                            }
                        }
                        
                        return base + "Qualquer desculpa √© boa para relaxar e cuidar da sua imagem. Mantenha essa energia de amor-pr√≥prio bem no topo!";
                    
                    case 'extras': return "Massagens e cuidados extra estimulam o fluxo sangu√≠neo e aceleram o crescimento. Um verdadeiro SPA em casa!";
                    default: return "Continue a acompanhar o seu Di√°rio para mais dicas.";
                }
            };

            const openModal = (type, title, icon, bgColor, iconColor, value, valColor) => {
                setActiveStatModal({ type, title, icon, bgColor, iconColor, value, valColor, insight: getInsightFor(type) });
            };

            const closeModal = () => {
                setIsClosingModal(true);
                setTimeout(() => {
                    setActiveStatModal(null);
                    setIsClosingModal(false);
                }, 350);
            };

            const currentYear = viewingMonth.getFullYear();
            const currentMonthIndex = viewingMonth.getMonth();
            const daysInMonth = new Date(currentYear, currentMonthIndex + 1, 0).getDate();
            const firstDayOfWeek = new Date(currentYear, currentMonthIndex, 1).getDay();
            const blanks = Array.from({ length: firstDayOfWeek }, (_, i) => i);
            const monthDays = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            const TabHeader = ({ titleContent, showOptions = false }) => (
                <div className="flex justify-between items-start mb-6">
                    <div className="flex-1">{titleContent}</div>
                    <div className={`flex items-center gap-2 ml-4 transition-opacity ${showOptions ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                        {deferredPrompt && <button onClick={() => deferredPrompt.prompt()} className={`${colors.primary} ${colors.primaryText} p-3 rounded-full shadow-sm`}><i className="ph-bold ph-download-simple text-xl"></i></button>}
                        <button onClick={toggleTheme} className={`${colors.yellow} p-3 rounded-full shadow-sm`}><i className={`ph-fill ${isDarkMode ? 'ph-moon' : 'ph-sun'} ${colors.yellowText} text-xl`}></i></button>
                        <button onClick={handleLogout} className={`${colors.card} border ${colors.border} p-3 rounded-full text-red-400 shadow-sm`}><i className="ph-bold ph-sign-out text-xl"></i></button>
                    </div>
                </div>
            );

            // --- TELAS AUTH ---
            if (authStep === 'auth') {
                return (
                    <div className={`min-h-[100dvh] w-full ${colors.bg} flex items-center justify-center p-4 transition-colors overflow-hidden`}>
                        <div className={`max-w-md w-full relative ${colors.bg} shadow-2xl flex flex-col rounded-[2.5rem] border ${colors.border}`}>
                            <div className="p-8 flex flex-col items-center text-center space-y-6">
                                <div className="flex w-full justify-end items-center absolute top-6 right-6">
                                    <button onClick={toggleTheme} className={`${colors.yellow} p-3 rounded-full shadow-sm`}>
                                        <i className={`ph-fill ${isDarkMode ? 'ph-moon' : 'ph-sun'} ${colors.yellowText} text-xl`}></i>
                                    </button>
                                </div>
                                <div className="mt-8">
                                    <div className={`w-24 h-24 mx-auto mb-4 rounded-full ${colors.primary} flex items-center justify-center`}>
                                        <i className={`ph-fill ph-flower-lotus ${colors.primaryText} text-5xl block`}></i>
                                    </div>
                                    <h1 className={`text-4xl font-black ${colors.text} font-serif tracking-tight`}>Meu Cabelo</h1>
                                    <p className={`text-sm ${colors.textLight} mt-2`}>O seu di√°rio de rotina e sa√∫de capilar.</p>
                                </div>
                                
                                <div className="w-full space-y-4 mt-6">
                                    <div className="flex w-full mb-6 p-1 bg-black/5 dark:bg-white/5 rounded-2xl">
                                        <button onClick={() => { setIsLoginFlow(true); setUsernameInput(''); setPasswordInput(''); }} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${isLoginFlow ? colors.card + ' shadow-sm ' + colors.textStrong : colors.textMuted}`}>Entrar</button>
                                        <button onClick={() => { setIsLoginFlow(false); setUsernameInput(''); setPasswordInput(''); }} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${!isLoginFlow ? colors.card + ' shadow-sm ' + colors.textStrong : colors.textMuted}`}>Registe-se</button>
                                    </div>

                                    <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                        <i className={`ph-fill ph-user ${colors.textLight} text-xl`}></i>
                                        <input type="text" placeholder="Utilizador" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                    </div>
                                    <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                        <i className={`ph-fill ph-lock-key ${colors.textLight} text-xl`}></i>
                                        <input type="password" placeholder="Palavra-passe" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                    </div>
                                </div>
                                <Button colors={colors} variant="primary" onClick={handleAuthSubmit} className="w-full py-4 mt-2 text-lg">{isLoginFlow ? 'Entrar no Di√°rio' : 'Criar Conta'}</Button>
                                
                                <div className="flex flex-col items-center gap-2 mt-2">
                                    {isLoginFlow && (
                                        <button onClick={() => { setAuthStep('recovery'); setUsernameInput(''); setPasswordInput(''); }} className={`text-xs font-bold ${colors.primaryText} hover:underline mt-2`}>
                                            Esqueceu a palavra-passe?
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="absolute top-4 w-full px-4 z-50 flex flex-col gap-2 pointer-events-none max-w-md mx-auto">
                            {notifications.map(n => (
                                <div key={n.id} className={`${n.isError ? 'bg-red-500/90 border-red-600' : colors.notification} p-4 rounded-2xl flex items-center shadow-lg pointer-events-auto border animate-in`}>
                                    <i className={`ph-fill ${n.isError ? 'ph-warning-circle text-white' : 'ph-info text-blue-500'} mr-2`}></i>
                                    <p className={`font-bold ${n.isError ? 'text-white' : colors.textStrong} text-sm`}>{n.msg}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            if (authStep === 'onboarding') {
                return (
                    <div className={`min-h-[100dvh] w-full ${colors.bg} flex items-center justify-center p-4 transition-colors overflow-hidden`}>
                        <div className={`max-w-md w-full relative ${colors.bg} shadow-2xl flex flex-col rounded-[2.5rem] border ${colors.border} p-8 text-center`}>
                            <i className={`ph-fill ph-sparkle ${colors.primaryText} text-4xl mb-4 bg-[#D2E0D9] p-4 rounded-full inline-block`}></i>
                            <h1 className={`text-2xl font-bold ${colors.text} font-serif`}>Como devemos chamar-lhe?</h1>
                            <div className="space-y-4 mt-8">
                                <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                    <i className={`ph-fill ph-user ${colors.textLight} text-xl`}></i>
                                    <input type="text" placeholder="O seu nome (ex: Joana)" value={userName} onChange={e => setUserName(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                </div>
                                <div className="text-left pt-2 pb-1">
                                    <label className={`text-sm font-bold ${colors.textMuted} ml-2`}>Pergunta para recupera√ß√£o de senha:</label>
                                </div>
                                <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                    <i className={`ph-fill ph-shield-check ${colors.textLight} text-xl`}></i>
                                    <input type="text" placeholder="Qual o nome da sua av√≥?" value={securityAnswerInput} onChange={e => setSecurityAnswerInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                </div>
                            </div>
                            <Button colors={colors} variant="primary" onClick={handleOnboardingSubmit} className="w-full py-4 mt-8 text-lg">Come√ßar a Usar</Button>
                        </div>
                        <div className="absolute top-4 w-full px-4 z-50 flex flex-col gap-2 pointer-events-none max-w-md mx-auto">
                            {notifications.map(n => <div key={n.id} className={`${n.isError ? 'bg-red-500/90 border-red-600' : colors.notification} p-4 rounded-2xl flex items-center shadow-lg pointer-events-auto border animate-in`}><i className={`ph-fill ${n.isError ? 'ph-warning-circle text-white' : 'ph-info text-blue-500'} mr-2`}></i><p className={`font-bold ${n.isError ? 'text-white' : colors.textStrong} text-sm`}>{n.msg}</p></div>)}
                        </div>
                    </div>
                );
            }

            if (authStep === 'recovery') {
                return (
                    <div className={`min-h-[100dvh] w-full ${colors.bg} flex items-center justify-center p-4 transition-colors overflow-hidden`}>
                        <div className={`max-w-md w-full relative ${colors.bg} shadow-2xl flex flex-col rounded-[2.5rem] border ${colors.border} p-8 text-center`}>
                            <button onClick={() => { setAuthStep('auth'); setUsernameInput(''); setSecurityAnswerInput(''); }} className={`absolute top-6 left-6 ${colors.textLight} hover:${colors.textStrong}`}>
                                <i className="ph-bold ph-arrow-left text-xl"></i>
                            </button>
                            <i className={`ph-fill ph-lock-key ${colors.primaryText} text-4xl mb-4 mt-4 bg-[#D2E0D9] p-4 rounded-full inline-block mx-auto`}></i>
                            <h1 className={`text-2xl font-bold ${colors.text} font-serif mb-6`}>Recuperar Palavra-passe</h1>
                            <div className="space-y-4">
                                <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                    <i className={`ph-fill ph-user ${colors.textLight} text-xl`}></i>
                                    <input type="text" placeholder="O seu Utilizador" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                </div>
                                <div className="text-left mt-4 mb-2">
                                    <label className={`text-sm font-bold ${colors.textMuted} ml-2`}>Responda √† pergunta de seguran√ßa:</label>
                                </div>
                                <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                    <i className={`ph-fill ph-question ${colors.textLight} text-xl`}></i>
                                    <input type="text" placeholder="Qual o nome da sua av√≥?" value={securityAnswerInput} onChange={e => setSecurityAnswerInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                </div>
                            </div>
                            <Button colors={colors} variant="primary" onClick={handleRecoverySubmit} className="w-full py-4 mt-8 text-lg">Recuperar</Button>
                        </div>
                        <div className="absolute top-4 w-full px-4 z-50 flex flex-col gap-2 pointer-events-none max-w-md mx-auto">
                            {notifications.map(n => <div key={n.id} className={`${n.isError ? 'bg-red-500/90 border-red-600' : colors.notification} p-4 rounded-2xl flex items-center shadow-lg pointer-events-auto border animate-in`}><i className={`ph-fill ${n.isError ? 'ph-warning-circle text-white' : 'ph-info text-blue-500'} mr-2`}></i><p className={`font-bold ${n.isError ? 'text-white' : colors.textStrong} text-sm`}>{n.msg}</p></div>)}
                        </div>
                    </div>
                );
            }

            return (
                <div className={`h-[100dvh] w-full ${colors.bg} transition-colors duration-500 overflow-hidden relative`}>
                    
                    {/* MODAL DE INSIGHT FLIP */}
                    {activeStatModal && (
                        <div className="absolute inset-0 z-[100] flex items-center justify-center p-6 bg-black/40 backdrop-blur-sm transition-opacity perspective-container" onClick={closeModal}>
                            <div className={`w-full max-w-[320px] ${colors.card} rounded-[2.5rem] p-8 shadow-2xl border ${colors.border} ${isClosingModal ? 'flip-card-exit' : 'flip-card-enter'} flex flex-col items-center text-center`} onClick={e => e.stopPropagation()}>
                                <button onClick={closeModal} className={`absolute top-5 right-5 ${colors.textLight} hover:${colors.textStrong} p-1`}><i className="ph-bold ph-x text-xl"></i></button>
                                <div className={`p-5 rounded-full ${activeStatModal.bgColor} mb-4`}>
                                    <i className={`ph-fill ${activeStatModal.icon} ${activeStatModal.iconColor} text-5xl`}></i>
                                </div>
                                <h2 className={`text-2xl font-bold ${colors.text} font-serif mb-1`}>{activeStatModal.title}</h2>
                                <p className={`text-4xl font-black ${activeStatModal.valColor} mb-6`}>{activeStatModal.value}</p>
                                <div className={`${colors.surface} p-4 rounded-3xl border ${colors.border} w-full shadow-inner`}>
                                    <p className={`text-sm font-medium ${colors.textStrong} leading-relaxed`}>{activeStatModal.insight}</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="absolute top-4 w-full px-4 z-50 flex flex-col gap-2 pointer-events-none max-w-md mx-auto left-1/2 -translate-x-1/2">
                        {notifications.map(n => (
                            <div key={n.id} className={`${n.isError ? 'bg-red-500/90 border-red-600' : colors.notification} p-4 rounded-2xl flex items-center shadow-lg pointer-events-auto border animate-in`}><i className={`ph-fill ${n.isError ? 'ph-warning-circle text-white' : 'ph-check-circle text-green-500'} mr-2 text-xl`}></i><p className={`font-bold ${n.isError ? 'text-white' : colors.textStrong} text-sm`}>{n.msg}</p></div>
                        ))}
                    </div>

                    <div className={`max-w-md mx-auto h-full relative ${colors.bg} flex flex-col overflow-hidden`}>
                        <div className="flex-1 w-full relative overflow-hidden">
                            <div 
                                className="w-[300%] h-full flex flex-nowrap transition-transform duration-[400ms] ease-[cubic-bezier(0.32,0.72,0,1)]"
                                style={{ transform: `translateX(-${activeIndex * (100 / 3)}%)` }}
                            >
                                
                                {/* --- ABA: HOJE (DI√ÅRIO CAPILAR) --- */}
                                <div className="w-1/3 h-full overflow-y-auto smooth-scroll p-6 scrollbar-hide pb-40">
                                    <TabHeader 
                                        showOptions={activeIndex === 0}
                                        titleContent={
                                            <>
                                                <p className={`text-xs ${colors.textLight} uppercase tracking-widest font-bold`}>{formatDateVisual(activeDateStr)}</p>
                                                <div className="mt-1 flex items-center">
                                                    {isEditingName && activeDateStr === realTodayStr ? (
                                                        <div className="flex items-center gap-2 w-full animate-in">
                                                            <span className={`text-2xl font-bold ${colors.text} font-serif`}>Ol√°,</span>
                                                            <input autoFocus value={editNameInput} onChange={e => setEditNameInput(e.target.value)} className={`bg-transparent border-b border-dashed ${colors.border} outline-none text-2xl font-bold ${colors.textStrong} font-serif w-32`} />
                                                            <button onClick={handleSaveName} className={`text-lg ml-1 ${colors.greenText}`}><i className="ph-bold ph-check"></i></button>
                                                            <button onClick={() => setIsEditingName(false)} className="text-lg text-red-400"><i className="ph-bold ph-x"></i></button>
                                                        </div>
                                                    ) : (
                                                        <h1 className={`text-3xl font-bold ${colors.text} font-serif flex items-center gap-2 tracking-tight`}>
                                                            {activeDateStr === realTodayStr ? (
                                                                <>
                                                                    Ol√°, {userName}!
                                                                    <button onClick={() => { setEditNameInput(userName); setIsEditingName(true); }} className={`p-1.5 rounded-full ${colors.surface} text-sm ${colors.textLight} hover:${colors.primaryText} transition-colors ml-1`}><i className="ph-bold ph-pencil-simple"></i></button>
                                                                </>
                                                            ) : 'Registo Antigo'}
                                                        </h1>
                                                    )}
                                                </div>
                                                {activeDateStr !== realTodayStr && (
                                                    <button onClick={() => setActiveDateStr(realTodayStr)} className={`text-xs ${colors.primaryText} font-bold mt-2 flex items-center gap-1 bg-[#D2E0D9] bg-opacity-30 px-3 py-1.5 rounded-full inline-flex`}><i className="ph-bold ph-arrow-left"></i> Voltar para Hoje</button>
                                                )}
                                            </>
                                        }
                                    />
                                    
                                    <div className="space-y-6 pb-8">
                                        
                                        {/* CARD 1: ESTADO DO CABELO */}
                                        <Card colors={colors} className="relative z-0">
                                            <div className="flex items-center gap-2 mb-4">
                                                <i className={`ph-fill ph-sparkle ${colors.accentText} text-xl`}></i>
                                                <h3 className={`font-semibold ${colors.text}`}>Como sente os fios hoje?</h3>
                                            </div>
                                            
                                            <div className="relative">
                                                {statusFeedback && (
                                                    <div className="absolute -top-12 left-1/2 -translate-x-1/2 z-[100] px-4 py-1.5 bg-[#282624] text-[#D6D0C4] dark:bg-stone-200 dark:text-stone-800 text-xs font-bold rounded-full shadow-lg toast-enter pointer-events-none whitespace-nowrap">
                                                        {statusFeedback}
                                                    </div>
                                                )}

                                                <div className={`flex flex-wrap justify-center gap-x-4 gap-y-3 ${colors.surface} p-4 rounded-2xl mb-4`}>
                                                    {HAIR_STATUS.map(s => (
                                                        <button type="button" key={s.id} onClick={() => handleStatusSelect(s)} className={`hover:scale-125 transition-transform ${s.color}`}>
                                                            <i className={`ph-fill ${s.icon} text-3xl`}></i>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            {dayLog.status.length > 0 && (
                                                <div className="flex flex-wrap gap-2">
                                                    {dayLog.status.map((s, i) => {
                                                        const statusData = HAIR_STATUS.find(x => x.id === s.status);
                                                        return (
                                                            <div key={i} className={`flex items-center gap-1 ${colors.surfaceAlt} px-3 py-1.5 rounded-full text-sm`}><i className={`ph-fill ${statusData.icon} ${statusData.color}`}></i><span className={`font-medium ${colors.textLight}`}>{s.time}</span><button onClick={() => updateActiveLog('status', dayLog.status.filter((_, idx) => idx !== i))} className="ml-1 text-red-400"><i className="ph-bold ph-x text-xs"></i></button></div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </Card>

                                        {/* CARD 2: PRODUTOS DI√ÅRIOS */}
                                        <Card colors={colors}>
                                            <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><i className={`ph-fill ph-drop ${colors.blueText} text-xl`}></i><h3 className={`font-semibold ${colors.text}`}>Uso Di√°rio</h3></div><button onClick={() => setIsAddingProduct(!isAddingProduct)} className={`p-1.5 rounded-full ${colors.blue} ${colors.blueText}`}><i className={`ph-bold ${isAddingProduct ? 'ph-x' : 'ph-plus'} text-lg`}></i></button></div>
                                            {isAddingProduct && (
                                                <div className={`${colors.blueCard} p-4 rounded-2xl mb-4 space-y-3 border`}>
                                                    <div className="flex gap-2">
                                                        <input placeholder="T√≥nico, √ìleo..." value={newProductInput.name} onChange={e => setNewProductInput({...newProductInput, name: e.target.value})} className={`flex-1 min-w-0 px-4 py-2 rounded-xl text-sm ${colors.input}`} />
                                                        <input type="time" value={newProductInput.time} onChange={e => setNewProductInput({...newProductInput, time: e.target.value})} className={`w-24 shrink-0 px-2 py-2 text-center rounded-xl text-sm ${colors.input}`} />
                                                    </div>
                                                    <Button type="button" colors={colors} variant="blue" onClick={handleAddProduct} className="w-full py-2">Guardar Produto</Button>
                                                </div>
                                            )}
                                            <div className="space-y-3">
                                                {products.length === 0 && !isAddingProduct && <p className={`text-xs ${colors.textMuted} text-center py-2`}>Nenhum produto di√°rio configurado.</p>}
                                                {products.map(prod => {
                                                    const isUsed = dayLog.routine?.[prod.id];
                                                    return (
                                                        <div key={prod.id} className={`flex items-center justify-between p-3 rounded-2xl border ${isUsed ? `${colors.primary} border-transparent` : `${colors.surface} ${colors.border}`}`}>
                                                            <div className="flex items-center gap-3"><div className={`p-2 rounded-full ${isUsed ? `${colors.translucent} ${colors.primaryText}` : `${colors.card} ${colors.iconMuted}`}`}><i className="ph-fill ph-flask text-lg"></i></div><div><p className={`font-bold ${isUsed ? colors.primaryText : colors.textStrong} text-sm`}>{prod.name}</p><p className={`text-xs ${isUsed ? colors.primaryText : colors.textLight}`}>{prod.time}</p></div></div>
                                                            <div className="flex gap-2"><button onClick={() => setProducts(products.filter(p => p.id !== prod.id))} className="text-red-400 p-2"><i className="ph-bold ph-x text-sm"></i></button><button onClick={() => { const r = {...(dayLog.routine || {})}; r[prod.id] = !r[prod.id]; updateActiveLog('routine', r); }} className={`w-10 h-10 rounded-full flex items-center justify-center border-2 ${isUsed ? `${colors.card} ${colors.primaryText} border-transparent` : `${colors.border} text-transparent`}`}><i className="ph-bold ph-check text-xl"></i></button></div>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </Card>

                                        {/* CARD 3: M√ÅSCARA / TRATAMENTO */}
                                        <Card colors={colors}>
                                            <div className="flex items-center gap-2 mb-4"><i className="ph-fill ph-magic-wand text-emerald-500 text-xl"></i><h3 className={`font-semibold ${colors.text}`}>Cronograma Capilar</h3></div>
                                            <div className="space-y-4">
                                                <div>
                                                    <label className={`text-sm ${colors.textLight} mb-2 block`}>Tempo de M√°scara: <span className={`font-bold ${colors.emeraldText}`}>{dayLog.treatment?.minutes || 0} min</span></label>
                                                    <input type="range" min="0" max="60" step="5" value={dayLog.treatment?.minutes || 0} onChange={(e) => updateActiveLog('treatment', { minutes: parseInt(e.target.value), type: dayLog.treatment?.type })} className="w-full accent-emerald-500" />
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    {TREATMENT_TYPES.map(q => (
                                                        <button type="button" key={q.id} onClick={() => updateActiveLog('treatment', { minutes: dayLog.treatment?.minutes || 0, type: q.id })} className={`w-full py-2.5 rounded-xl text-xs font-bold border transition-all ${dayLog.treatment?.type === q.id ? 'bg-emerald-500/20 text-emerald-600 border-emerald-200' : `${colors.surface} ${colors.text} border-transparent`}`}>{q.label}</button>
                                                    ))}
                                                </div>
                                            </div>
                                        </Card>

                                        {/* CARD 4: FONTES DE CALOR */}
                                        <Card colors={colors} className={`flex flex-col gap-4 ${colors.orange} bg-opacity-20 border-orange-200`}>
                                            <div className="flex items-center gap-2"><i className="ph-fill ph-fire text-orange-500 text-xl"></i><h3 className={`font-semibold ${colors.textStrong}`}>Uso de Calor</h3></div>
                                            
                                            <div className="flex flex-col gap-2">
                                                <button type="button" onClick={() => updateActiveLog('heat', { ...dayLog.heat, active: !dayLog.heat.active })} className={`flex items-center justify-between p-3.5 rounded-xl border-2 transition-all ${dayLog.heat.active ? 'border-orange-400 bg-orange-100/50 dark:bg-orange-900/30' : 'border-transparent ' + colors.surface}`}>
                                                    <span className={`text-sm font-bold ${dayLog.heat.active ? colors.orangeText : colors.text}`}>Usei Secador / Chapinha</span>
                                                    <div className={`w-6 h-6 rounded-md flex items-center justify-center border transition-colors ${dayLog.heat.active ? 'bg-orange-500 border-orange-500 text-white shadow-sm' : colors.border + ' bg-transparent'}`}>
                                                        {dayLog.heat.active && <i className="ph-bold ph-check"></i>}
                                                    </div>
                                                </button>

                                                {dayLog.heat.active && (
                                                    <button type="button" onClick={() => updateActiveLog('heat', { ...dayLog.heat, protectant: !dayLog.heat.protectant })} className={`flex items-center justify-between p-3.5 rounded-xl border-2 transition-all animate-in ${dayLog.heat.protectant ? 'border-green-400 bg-green-100/50 dark:bg-green-900/30' : 'border-red-200 bg-red-50/50 dark:bg-red-900/20'}`}>
                                                        <span className={`text-sm font-bold ${dayLog.heat.protectant ? 'text-green-600' : 'text-red-400'}`}>Apliquei Protetor T√©rmico</span>
                                                        <div className={`w-6 h-6 rounded-md flex items-center justify-center border transition-colors ${dayLog.heat.protectant ? 'bg-green-500 border-green-500 text-white shadow-sm' : 'border-red-300 bg-transparent'}`}>
                                                            {dayLog.heat.protectant && <i className="ph-bold ph-check"></i>}
                                                        </div>
                                                    </button>
                                                )}
                                            </div>
                                        </Card>

                                        {/* CARD 5: SAL√ÉO */}
                                        <Card colors={colors} className={`${colors.purple} bg-opacity-20`}>
                                            <div className="flex items-center gap-2 mb-4"><i className={`ph-fill ph-scissors ${colors.purpleText} text-xl`}></i><h3 className={`font-semibold ${colors.text}`}>Ida ao Sal√£o</h3></div>
                                            {dayLog.salon ? (
                                                <div className={`${colors.translucentStrong} p-4 rounded-xl shadow-sm`}>
                                                    <div className="mb-2">
                                                        <p className={`text-xs ${colors.textMuted} uppercase font-bold`}>Procedimentos</p>
                                                        <p className={`font-bold ${colors.textStrong}`}>{dayLog.salon.procedures}</p>
                                                    </div>
                                                    {dayLog.salon.notes && (
                                                        <div className="mb-3">
                                                            <p className={`text-[10px] ${colors.textMuted} uppercase font-bold`}>Notas</p>
                                                            <p className={`text-sm ${colors.textStrong} opacity-90`}>{dayLog.salon.notes}</p>
                                                        </div>
                                                    )}
                                                    <div className="flex justify-between items-center border-t border-purple-200 pt-3 mt-1">
                                                        <span className={`${HAIR_STATUS.find(m => m.id === dayLog.salon.mood)?.color} flex items-center gap-1 text-sm font-bold`}><i className={`ph-fill ${HAIR_STATUS.find(m => m.id === dayLog.salon.mood)?.icon} text-xl`}></i> Resultado</span>
                                                        <div className="flex gap-3">
                                                            <button onClick={() => { setSalonInput(dayLog.salon); updateActiveLog('salon', null); }} className="text-blue-500 text-sm flex items-center gap-1"><i className="ph-bold ph-pencil-simple"></i></button>
                                                            <button onClick={() => updateActiveLog('salon', null)} className="text-red-400 text-sm flex items-center gap-1"><i className="ph-bold ph-trash"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="space-y-4">
                                                    <div>
                                                        <div className="flex gap-2 mb-3 overflow-x-auto scrollbar-hide pb-1">
                                                            {['Corte', 'Pintura', 'Madeixas', 'Escova'].map(p => (
                                                                <button type="button" key={p} onClick={() => setSalonInput({...salonInput, procedures: salonInput.procedures ? salonInput.procedures + ', ' + p : p})} className={`text-[11px] font-bold px-3 py-1.5 rounded-full ${colors.surface} ${colors.textStrong} whitespace-nowrap shadow-sm border border-stone-200 dark:border-stone-700`}>+ {p}</button>
                                                            ))}
                                                        </div>
                                                        <input placeholder="Ex: Corte e Nuances" value={salonInput.procedures} onChange={e => setSalonInput({...salonInput, procedures: e.target.value})} className={`w-full p-3 rounded-xl ${colors.input} mb-2`} />
                                                        <input placeholder="Anota√ß√µes..." value={salonInput.notes} onChange={e => setSalonInput({...salonInput, notes: e.target.value})} className={`w-full p-3 rounded-xl ${colors.input}`} />
                                                    </div>
                                                    <div>
                                                        <label className={`text-xs ${colors.textMuted} mb-2 block text-center font-bold`}>Como se sentiu com o resultado?</label>
                                                        <div className={`flex justify-between items-center ${colors.card} p-2 rounded-xl overflow-x-auto gap-2`}>{HAIR_STATUS.map(m => (<button type="button" key={m.id} onClick={() => setSalonInput({...salonInput, mood: m.id})} className={`p-1.5 shrink-0 rounded-full ${salonInput.mood === m.id ? `${colors.surface} shadow-sm ${m.color}` : 'opacity-40 grayscale'}`}><i className={`ph-fill ${m.icon} text-3xl`}></i></button>))}</div>
                                                    </div>
                                                    <Button type="button" colors={colors} variant="purple" onClick={() => { if (salonInput.procedures) { updateActiveLog('salon', salonInput); setSalonInput({ procedures: '', notes: '', mood: 'perfeito' }); } }} className="w-full py-3 shadow-sm">Salvar Sal√£o</Button>
                                                </div>
                                            )}
                                        </Card>

                                        {/* CARD 6: EXTRAS */}
                                        <Card colors={colors} className={`${colors.teal} bg-opacity-20 p-5`}>
                                            <div className="flex items-center gap-2 mb-4"><i className={`ph-fill ph-hand-heart ${colors.tealText} text-xl`}></i><h3 className={`font-semibold ${colors.text}`}>Cuidados Extras</h3></div>
                                            <div className="flex gap-2 mb-4"><input placeholder="Ex: Massagem Capilar" value={extraInput.type} onChange={e => setExtraInput({...extraInput, type: e.target.value})} className={`flex-1 min-w-0 p-2 rounded-lg ${colors.input}`} /><input type="number" placeholder="Min" value={extraInput.duration} onChange={e => setExtraInput({...extraInput, duration: e.target.value})} className={`w-16 shrink-0 p-2 rounded-lg text-center ${colors.input}`} /><button type="button" onClick={() => { if(extraInput.type && extraInput.duration) { updateActiveLog('extras', [...dayLog.extras, {type: extraInput.type, duration: parseInt(extraInput.duration)}]); setExtraInput({type:'',duration:''}); } }} className={`${colors.teal} ${colors.tealText} px-3 rounded-lg font-bold shrink-0`}><i className="ph-bold ph-plus"></i></button></div>
                                            {dayLog.extras?.map((ex, i) => (<div key={i} className={`flex justify-between items-center ${colors.translucentStrong} p-2 rounded-lg text-sm mt-2`}><span className={colors.textStrong}>{ex.type}</span><div className="flex items-center gap-3"><span className={`text-xs ${colors.textMuted}`}>{ex.duration}m</span><button type="button" onClick={() => updateActiveLog('extras', dayLog.extras.filter((_, idx) => idx !== i))} className="text-red-400 shrink-0"><i className="ph-bold ph-x"></i></button></div></div>))}
                                        </Card>

                                    </div>
                                </div>

                                {/* --- ABA: HIST√ìRICO --- */}
                                <div className="w-1/3 h-full overflow-y-auto smooth-scroll p-6 scrollbar-hide pb-40">
                                    <TabHeader 
                                        showOptions={activeIndex === 1}
                                        titleContent={<h1 className={`text-3xl font-bold ${colors.text} font-serif mt-1 tracking-tight`}>Hist√≥rico</h1>}
                                    />
                                    <div className="space-y-6 pb-8">
                                        <Card colors={colors} className="p-4 cursor-default">
                                            <div className="flex justify-between items-center mb-6">
                                                <button onClick={() => setViewingMonth(new Date(currentYear, currentMonthIndex - 1, 1))} className={`p-2 ${colors.surface} rounded-full`}><i className="ph-bold ph-caret-left"></i></button>
                                                <h2 className={`font-bold ${colors.textStrong}`}>{MONTHS[currentMonthIndex]} {currentYear}</h2>
                                                <button onClick={() => setViewingMonth(new Date(currentYear, currentMonthIndex + 1, 1))} className={`p-2 ${colors.surface} rounded-full`}><i className="ph-bold ph-caret-right"></i></button>
                                            </div>
                                            <div className="grid grid-cols-7 gap-y-2 text-center">
                                                {WEEKDAYS.map(day => <div key={day} className={`text-xs font-bold ${colors.textLight} py-2`}>{day}</div>)}
                                                {blanks.map(blank => <div key={`blank-${blank}`} className="w-8 h-8"></div>)}
                                                {monthDays.map(day => {
                                                    const dateStr = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                                    const dayData = logs[dateStr];
                                                    const hasData = dayData && (dayData.status?.length>0 || dayData.treatment?.minutes>0 || dayData.salon || dayData.heat?.active || dayData.extras?.length>0 || Object.keys(dayData.routine||{}).length>0);
                                                    const isSel = selectedHistoryDate === dateStr;
                                                    return (
                                                        <button key={day} onClick={() => setSelectedHistoryDate(dateStr)} className={`w-8 h-8 mx-auto flex flex-col items-center justify-center rounded-xl font-bold text-sm transition-all ${isSel ? `${colors.primary} ${colors.primaryText} shadow-md` : `${colors.text} hover:${colors.surfaceHover}`}`}>
                                                            {day}
                                                            {hasData && <span className={`w-1 h-1 rounded-full mt-0.5 ${isSel ? 'bg-[#4A6B5D]' : 'bg-stone-300'}`}></span>}
                                                        </button>
                                                    )
                                                })}
                                            </div>
                                        </Card>

                                        <div className="mt-8 mb-8">
                                            <h3 className={`text-lg font-bold ${colors.text} mb-4 flex justify-between items-center`}>
                                                <span><i className="ph-fill ph-calendar"></i> {formatDateVisual(selectedHistoryDate)}</span>
                                            </h3>
                                            
                                            {logs[selectedHistoryDate] && (logs[selectedHistoryDate].status?.length>0 || logs[selectedHistoryDate].treatment?.minutes>0 || logs[selectedHistoryDate].salon || logs[selectedHistoryDate].heat?.active || logs[selectedHistoryDate].extras?.length>0 || Object.keys(logs[selectedHistoryDate].routine||{}).length>0) ? (
                                                <div className="space-y-4">
                                                    <div className="grid grid-cols-2 gap-3">
                                                        {logs[selectedHistoryDate].status?.length > 0 && (
                                                            <Card colors={colors} className={`col-span-2 p-4 ${colors.surface}`}>
                                                                <div className="flex gap-2 flex-wrap">{logs[selectedHistoryDate].status.map((m, i) => <div key={i} className={`flex items-center gap-1 ${colors.card} px-3 py-1 rounded-full text-xs shadow-sm border ${colors.border}`}><i className={`ph-fill ${HAIR_STATUS.find(x=>x.id===m.status)?.icon} ${HAIR_STATUS.find(x=>x.id===m.status)?.color}`}></i> <span className={`font-medium ${colors.textStrong}`}>{m.time}</span></div>)}</div>
                                                            </Card>
                                                        )}
                                                        {logs[selectedHistoryDate].salon && (
                                                            <Card colors={colors} className={`col-span-2 p-4 ${colors.purpleCard}`}>
                                                                <div className="flex justify-between items-center"><div><p className={`text-xs ${colors.purpleText} font-bold`}><i className="ph-fill ph-scissors"></i> Sal√£o</p><p className={`font-bold ${colors.textStrong} text-sm mt-1`}>{logs[selectedHistoryDate].salon.procedures}</p><p className={`text-xs ${colors.textMuted} font-medium mt-1`}>{logs[selectedHistoryDate].salon.notes}</p></div><i className={`ph-fill ${HAIR_STATUS.find(m => m.id === logs[selectedHistoryDate].salon.mood)?.icon} ${HAIR_STATUS.find(m => m.id === logs[selectedHistoryDate].salon.mood)?.color} text-3xl`}></i></div>
                                                            </Card>
                                                        )}
                                                        {products.length > 0 && (
                                                            <Card colors={colors} className={`col-span-2 p-4 ${colors.blueCard}`}>
                                                                <p className={`text-xs ${colors.blueTextAlt} font-bold`}><i className="ph-fill ph-drop"></i> Rotina Di√°ria</p>
                                                                <div className="mt-2 space-y-1">{products.map(prod => { const taken = logs[selectedHistoryDate].routine?.[prod.id]; return <p key={prod.id} className={`text-xs ${taken ? colors.textStrong + ' font-medium' : colors.textMuted + ' line-through'}`}>{taken ? '‚úÖ' : '‚ùå'} {prod.name}</p> })}</div>
                                                            </Card>
                                                        )}
                                                        {logs[selectedHistoryDate].treatment?.minutes > 0 && (
                                                            <Card colors={colors} className={`p-4 ${colors.emerald} bg-opacity-20`}>
                                                                <p className={`text-xs ${colors.emeraldText} font-bold`}><i className="ph-fill ph-magic-wand"></i> M√°scara</p>
                                                                <p className={`font-bold ${colors.emeraldText} text-lg mt-1`}>{logs[selectedHistoryDate].treatment.minutes}m</p>
                                                                <p className={`text-xs font-bold ${colors.emeraldText} opacity-70`}>{TREATMENT_TYPES.find(t=>t.id === logs[selectedHistoryDate].treatment.type)?.label}</p>
                                                            </Card>
                                                        )}
                                                        {(logs[selectedHistoryDate].heat?.active) && (
                                                            <Card colors={colors} className={`p-4 flex flex-col justify-center ${colors.orange} bg-opacity-20`}>
                                                                <p className={`text-xs ${colors.orangeText} font-bold flex items-center gap-1`}><i className="ph-fill ph-fire text-sm"></i> Calor</p>
                                                                <p className={`font-bold ${colors.textStrong} text-sm mt-1`}>Secador/Chapinha</p>
                                                                <p className={`text-[10px] font-bold mt-1 ${logs[selectedHistoryDate].heat.protectant ? 'text-green-600' : 'text-red-500'}`}>
                                                                    {logs[selectedHistoryDate].heat.protectant ? '‚úÖ Com prote√ß√£o' : '‚ùå Sem prote√ß√£o'}
                                                                </p>
                                                            </Card>
                                                        )}
                                                        {logs[selectedHistoryDate].extras?.length > 0 && (
                                                            <Card colors={colors} className={`col-span-1 p-4 ${colors.teal} bg-opacity-20`}>
                                                                <p className={`text-xs ${colors.tealText} font-bold`}><i className="ph-fill ph-hand-heart"></i> Extras</p><div className="mt-2 space-y-1">{logs[selectedHistoryDate].extras.map((c,i) => <p key={i} className={`text-sm font-medium ${colors.textStrong}`}>{c.type} <span className={`text-xs font-normal ${colors.textMuted}`}>({c.duration}m)</span></p>)}</div>
                                                            </Card>
                                                        )}
                                                    </div>
                                                    <Button type="button" colors={colors} variant="outline" onClick={() => { setActiveDateStr(selectedHistoryDate); setActiveTab('home'); }} className="w-full mt-4 text-sm border-2">
                                                        <i className="ph-bold ph-pencil-simple"></i> Editar este dia
                                                    </Button>
                                                </div>
                                            ) : (
                                                <div className="text-center py-8">
                                                    <p className={`text-sm ${colors.textMuted} mb-4`}>Nenhum cuidado capilar registado.</p>
                                                    <Button type="button" colors={colors} variant="primary" onClick={() => { setActiveDateStr(selectedHistoryDate); setActiveTab('home'); }} className="mx-auto text-sm">
                                                        <i className="ph-bold ph-plus"></i> Criar registo
                                                    </Button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>


                                {/* --- ABA: ESTAT√çSTICAS / RESUMO --- */}
                                <div className="w-1/3 h-full overflow-y-auto smooth-scroll p-6 scrollbar-hide pb-40">
                                    <TabHeader 
                                        showOptions={activeIndex === 2}
                                        titleContent={<h1 className={`text-3xl font-bold ${colors.text} font-serif mt-1`}>O Meu Cabelo</h1>}
                                    />
                                    <div className="space-y-6 pb-8">
                                        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide smooth-scroll">
                                            {STAT_PERIODS.map(period => (
                                                <button key={period.val} onClick={() => setStatsPeriod(period.val)} className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap ${statsPeriod === period.val ? `${colors.primary} ${colors.primaryText}` : `${colors.card} ${colors.textLight} border ${colors.border}`}`}>{period.label}</button>
                                            ))}
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            
                                            {/* STATUS CARD FLIP */}
                                            <Card onClick={() => openModal('status', 'Estado do Fio', stats.topStatus.icon, `${colors.yellow} bg-opacity-30`, stats.topStatus.color, stats.topStatus.label, colors.textStrong)} colors={colors} className="col-span-2 flex justify-between items-center relative overflow-hidden group cursor-pointer hover:shadow-md transition-all">
                                                <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                <div><p className={`text-sm ${colors.textLight} font-bold uppercase tracking-wider mb-1`}>Como tem estado?</p><h3 className={`text-xl font-bold ${colors.textStrong}`}>{stats.topStatus.label}</h3></div>
                                                <div className={`p-4 rounded-2xl ${colors.yellow} bg-opacity-30`}><i className={`ph-fill ${stats.topStatus.icon} ${stats.topStatus.color} text-4xl`}></i></div>
                                            </Card>

                                            {/* TRATAMENTO */}
                                            <Card onClick={() => openModal('treatment', 'Tratamentos', 'ph-magic-wand', `${colors.emerald} bg-opacity-20`, colors.emeraldText, `${stats.totalTreatMins}m`, colors.emeraldText)} colors={colors} className={`col-span-1 flex flex-col items-center text-center gap-2 p-5 ${colors.emerald} bg-opacity-20 relative overflow-hidden group border-none cursor-pointer hover:shadow-md transition-all`}>
                                                <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                <i className={`ph-fill ph-magic-wand ${colors.emeraldText} text-4xl mb-1`}></i>
                                                <p className={`text-xs font-bold uppercase tracking-widest ${colors.textLight}`}>M√°scara</p>
                                                <p className={`text-3xl font-black ${colors.emeraldText}`}>{stats.totalTreatMins}m</p>
                                            </Card>

                                            {/* ROTINA */}
                                            <Card onClick={() => openModal('routine', 'Ades√£o Rotina', 'ph-drop', `${colors.blueCard}`, colors.blueTextAlt, `${stats.routineAdherence}%`, colors.textStrong)} colors={colors} className={`col-span-1 flex flex-col items-center text-center gap-2 p-5 ${colors.blueCard} relative overflow-hidden group border-none cursor-pointer hover:shadow-md transition-all`}>
                                                <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                <i className={`ph-fill ph-drop ${colors.blueText} text-4xl mb-1`}></i>
                                                <p className={`text-xs font-bold uppercase tracking-widest ${colors.textLight}`}>Produtos</p>
                                                <p className={`text-3xl font-black ${colors.blueTextAlt}`}>{stats.routineAdherence}%</p>
                                            </Card>

                                            {/* SAL√ÉO */}
                                            <Card onClick={() => openModal('salon', 'Ida ao Sal√£o', 'ph-scissors', `${colors.purpleCard}`, colors.purpleText, `${stats.totalSalon} vezes`, colors.purpleText)} colors={colors} className={`col-span-2 ${colors.purpleCard} relative overflow-hidden group cursor-pointer hover:shadow-md transition-all`}>
                                                <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                <div className="flex justify-between items-start mb-4">
                                                    <h3 className={`font-bold ${colors.textStrong} flex items-center gap-2`}><i className={`ph-fill ph-scissors ${colors.purpleText} text-2xl`}></i> Sal√£o</h3>
                                                    {stats.topSalonMood && <div className="text-right"><p className={`text-xs ${colors.textMuted} mb-1 font-bold`}>Resultado Geral</p><i className={`ph-fill ${stats.topSalonMood.icon} ${stats.topSalonMood.color} text-2xl`}></i></div>}
                                                </div>
                                                <div className={`${colors.translucentStrong} p-4 rounded-2xl flex justify-between items-center shadow-sm`}>
                                                    <span className={`text-sm font-bold ${colors.textLight}`}>Mimos profissionais</span>
                                                    <span className={`text-2xl font-black ${colors.purpleText}`}>{stats.totalSalon}</span>
                                                </div>
                                            </Card>

                                            {/* CALOR */}
                                            <Card onClick={() => openModal('heat', 'Uso de Calor', 'ph-fire', `${colors.orange} bg-opacity-20`, colors.orangeText, `${stats.heatDays} dias`, colors.orangeText)} colors={colors} className={`col-span-2 flex justify-between items-center p-6 ${colors.orange} bg-opacity-20 relative overflow-hidden group border-none cursor-pointer hover:shadow-md transition-all`}>
                                                <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                <div>
                                                    <p className={`text-xs font-bold uppercase tracking-widest ${colors.textLight} mb-1`}>Secador / Chapinha</p>
                                                    <p className={`text-3xl font-black ${colors.orangeText}`}>{stats.heatDays} <span className="text-sm font-bold">dias</span></p>
                                                    {stats.heatDays > 0 && <p className={`text-xs font-bold mt-1 ${stats.protectedDays === stats.heatDays ? 'text-green-600' : 'text-red-500'}`}>{stats.protectedDays} com prote√ß√£o t√©rmica</p>}
                                                </div>
                                                <i className="ph-fill ph-fire text-orange-500 text-5xl opacity-80"></i>
                                            </Card>

                                            {/* EXTRAS */}
                                            <Card onClick={() => openModal('extras', 'Extras', 'ph-hand-heart', `${colors.teal} bg-opacity-20`, colors.tealText, `${stats.totalExtrasMins}m`, colors.tealText)} colors={colors} className={`col-span-2 flex justify-between items-center p-6 relative overflow-hidden group border-2 ${colors.border} cursor-pointer hover:shadow-md transition-all`}>
                                                <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                <div className="flex items-center gap-4">
                                                    <div className={`p-4 rounded-2xl ${colors.teal} bg-opacity-20`}><i className={`ph-fill ph-hand-heart ${colors.tealText} text-3xl`}></i></div>
                                                    <div>
                                                        <p className={`text-xs font-bold uppercase tracking-widest ${colors.textLight} mb-0.5`}>Massagens & Cuidados</p>
                                                        <p className={`text-xl font-black ${colors.textStrong}`}>{stats.totalExtrasMins} <span className="text-sm font-bold">minutos</span></p>
                                                    </div>
                                                </div>
                                            </Card>
                                        </div>
                                    </div>
                                </div>
                            
                            </div>
                        </div>

                        {/* --- DYNAMIC ISLAND (MENU INFERIOR) PERFEITO --- */}
                        <div 
                            className={`absolute bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-[340px] flex flex-col items-center ${colors.bottomNav} backdrop-blur-xl border ${colors.border} rounded-[2rem] z-[60] shadow-[0_10px_40px_rgba(0,0,0,0.15)] transition-all duration-300 ease-[cubic-bezier(0.32,0.72,0,1)] overflow-hidden ${isNavOpen ? 'h-[130px]' : 'h-14'}`}
                        >
                            <div 
                                className="w-full h-14 flex flex-col justify-center items-center shrink-0 cursor-pointer hover:bg-black/5 transition-colors absolute top-0 z-10" 
                                onTouchStart={handleNavTouchStart}
                                onTouchMove={handleNavTouchMove}
                                onTouchEnd={handleNavTouchEnd}
                                onClick={handleNavClick}
                            >
                                <div className={`w-12 h-1.5 rounded-full ${colors.textMuted} opacity-30 mb-1.5 mt-1 pointer-events-none`}></div>
                                <i className={`ph-bold ${isNavOpen ? 'ph-caret-down' : 'ph-caret-up'} ${colors.textLight} text-sm pointer-events-none`}></i>
                            </div>
                            
                            <div className={`w-full h-full flex justify-center items-center gap-3 sm:gap-6 pt-12 px-2 pb-2 transition-opacity duration-300 ${isNavOpen ? 'opacity-100 delay-100' : 'opacity-0 pointer-events-none'}`}>
                                <button onClick={(e) => { e.stopPropagation(); setActiveTab('home'); setIsNavOpen(false); }} className={`flex-1 max-w-[90px] py-2.5 rounded-2xl flex flex-col items-center gap-1.5 transition-all hover:scale-105 ${activeTab === 'home' ? `${colors.primary} ${colors.primaryText} shadow-sm` : colors.textLight}`}>
                                    <i className="ph-fill ph-hand-heart text-[26px]"></i><span className="text-[10px] font-bold uppercase tracking-wider">Di√°rio</span>
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); setActiveTab('calendar'); setIsNavOpen(false); }} className={`flex-1 max-w-[90px] py-2.5 rounded-2xl flex flex-col items-center gap-1.5 transition-all hover:scale-105 ${activeTab === 'calendar' ? `${colors.primary} ${colors.primaryText} shadow-sm` : colors.textLight}`}>
                                    <i className="ph-fill ph-calendar-blank text-[26px]"></i><span className="text-[10px] font-bold uppercase tracking-wider">Hist√≥rico</span>
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); setActiveTab('stats'); setIsNavOpen(false); }} className={`flex-1 max-w-[90px] py-2.5 rounded-2xl flex flex-col items-center gap-1.5 transition-all hover:scale-105 ${activeTab === 'stats' ? `${colors.primary} ${colors.primaryText} shadow-sm` : colors.textLight}`}>
                                    <i className="ph-fill ph-sparkle text-[26px]"></i><span className="text-[10px] font-bold uppercase tracking-wider">Resumo</span>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


